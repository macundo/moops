
find_program(SSH_COMMAND NAMES ssh)
find_program(SSH_COMMAND NAMES scp)
# Sets the variable GIT_COMMANDS
macro(SET_GIT_COMMANDS CLONE_PROJECT)
    set(GIT_COMMANDS "bash <<EOF")
    IF(${CLONE_PROJECT} MATCHES "ON")
        set(GIT_COMMANDS ${GIT_COMMANDS} "\nif [ -d ${MOOPS_SOURCE_DIR} ]\; then")
        set(GIT_COMMANDS "${GIT_COMMANDS} \n  rm -Rf ${MOOPS_SOURCE_DIR}")
        set(GIT_COMMANDS "${GIT_COMMANDS} \nfi")
        set(GIT_COMMANDS "${GIT_COMMANDS} \ngit clone git@bitbucket.org:ricortiz/moops.git ${MOOPS_SOURCE_DIR}")
    else()
        set(GIT_COMMANDS "${GIT_COMMANDS} \nif [ -d ${MOOPS_SOURCE_DIR} ]\; then")
        set(GIT_COMMANDS "${GIT_COMMANDS} \n  cmake pull")
        set(GIT_COMMANDS "${GIT_COMMANDS} \nfi")
    ENDIF()
    set(GIT_COMMANDS "${GIT_COMMANDS} \nEOF")
    execute_process(COMMAND ${SSH_COMMAND} ${REMOTE_SERVER} ${GIT_COMMANDS} RESULT_VARIABLE out OUTPUT_QUIET)
endmacro(SET_GIT_COMMANDS)

macro(SET_BUILD_COMMANDS ${CMAKE_CACHE})
    set(BUILD_COMMANDS "bash <<EOF")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \nif [ ! -d ${MOOPS_BINARY_DIR} ]\; then")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \n    mkdir ${MOOPS_BINARY_DIR}")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \nfi")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \ncd ${MOOPS_BINARY_DIR}")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \ncmake ${CMAKE_CACHE} ${MOOPS_SOURCE_DIR}")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \nmake ${PROGRAM_NAME}")
    set(BUILD_COMMANDS "${BUILD_COMMANDS} \nEOF")
    execute_process(COMMAND ${SSH_COMMAND} ${REMOTE_SERVER} ${BUILD_COMMANDS} RESULT_VARIABLE out OUTPUT_QUIET)
endmacro(SET_BUILD_COMMANDS)

# sets the variable BSUB_COMMANDS
macro(SET_BSUB_COMMANDS EXE JOB_NAME QUEUE)
    set(BSUB_COMMANDS "bsub <<EOF")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n####   Run program    ####")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -q ${QUEUE}")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -J ${JOB_NAME}")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -n 2")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -T 12")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -x")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -o out.%J")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n#BSUB -e err.%J")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \nmpirun ${EXE}")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \n####   End run program    ####")
    set(BSUB_COMMANDS "${BSUB_COMMANDS} \nEOF")
endmacro(SET_BSUB_COMMANDS)

macro(SUBMIT_JOB TARGET_NAME)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/Submit${PROGRAM_NAME}Job.sh "#!/bin/bash \n\n${BSUB_COMMANDS}")
    execute_process(COMMAND ${SCP_COMMAND} ${CMAKE_CURRENT_BINARY_DIR}/Submit${PROGRAM_NAME}Job.sh ${REMOTE_SERVER}:${SCRATCH_REMOTE_DIRECTORY}/ RESULT_VARIABLE out OUTPUT_QUIET)
    add_custom_target(${TARGET_NAME} COMMAND ${SSH_COMMAND} ${REMOTE_SERVER} sh ${SCRATCH_REMOTE_DIRECTORY}/Submit${PROGRAM_NAME}Job.sh)
endmacro()
